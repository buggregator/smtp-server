# Master Checklist: SMTP Plugin Jobs Integration

## Общий прогресс

| Этап | Описание | Статус |
|------|----------|--------|
| 1 | Конфигурация и интерфейсы | ⬜ |
| 2 | Jobs интеграция | ⬜ |
| 3 | Удаление WorkerPool | ⬜ |
| 4 | Обновление RPC и зависимостей | ⬜ |
| 5 | Тесты и документация | ⬜ |

---

## Этап 1: Конфигурация и интерфейсы

### 1.1 Структуры конфигурации
- [ ] Добавить `JobsConfig` структуру в `config.go`
- [ ] Добавить поле `Jobs JobsConfig` в `Config` структуру
- [ ] Реализовать `InitDefaults()` для Jobs конфигурации
- [ ] Добавить валидацию `jobs.pipeline` в `validate()`

### 1.2 Интерфейс Jobs RPC
- [ ] Создать файл `jobs_rpc.go` с интерфейсом `JobsRPCer`
- [ ] Определить методы `Push()` и `PushBatch()`
- [ ] Добавить поле `jobsRPC JobsRPCer` в `Plugin` структуру

### 1.3 Структура EmailJob
- [ ] Создать структуру `EmailJob` в `types.go`
- [ ] Реализовать метод `ToJobsRequest()`
- [ ] Добавить конвертацию из `ParsedMessage`

---

## Этап 2: Jobs интеграция

### 2.1 Push метод
- [ ] Реализовать `pushToJobs()` в `plugin.go`
- [ ] Добавить обработку ошибок RPC
- [ ] Добавить логирование

### 2.2 Модификация Session.Data()
- [ ] Изменить `session.go:Data()` для вызова `pushToJobs()`
- [ ] Заменить вызов `sendToWorker()` на Jobs push
- [ ] Обновить обработку ошибок

### 2.3 Batch processing (опционально)
- [ ] Добавить буферизацию для batch push
- [ ] Реализовать flush по таймеру/размеру

---

## Этап 3: Удаление WorkerPool

### 3.1 Удаление из Plugin
- [ ] Удалить поле `wPool Pool` из `Plugin` структуры
- [ ] Удалить поле `pldPool sync.Pool`
- [ ] Удалить поле `server Server`
- [ ] Удалить интерфейс `Pool`
- [ ] Удалить интерфейс `Server`

### 3.2 Рефакторинг Serve()
- [ ] Удалить создание worker pool (строка 121)
- [ ] Удалить `defer p.wPool.Destroy()`
- [ ] Обновить проверку зависимости на Jobs

### 3.3 Рефакторинг Stop()
- [ ] Удалить вызов `p.wPool.Destroy()`
- [ ] Упростить логику остановки

### 3.4 Удаление файлов
- [ ] Удалить `handler.go` (sendToWorker)
- [ ] Удалить `workers_manager.go`

---

## Этап 4: Обновление RPC и зависимостей

### 4.1 Удаление RPC методов
- [ ] Удалить `AddWorker` из `rpc.go`
- [ ] Удалить `RemoveWorker` из `rpc.go`
- [ ] Удалить `WorkersList` из `rpc.go`

### 4.2 Endure интеграция
- [ ] Добавить `Collects()` метод для Jobs зависимости
- [ ] Обновить `Init()` для проверки конфигурации
- [ ] Обновить `Serve()` для проверки jobsRPC

### 4.3 Удаление неиспользуемого кода
- [ ] Удалить `Reset()` метод
- [ ] Удалить `Workers()` метод
- [ ] Очистить импорты

---

## Этап 5: Тесты и документация

### 5.1 Unit тесты
- [ ] Тест конвертации `EmailJob.ToJobsRequest()`
- [ ] Тест валидации конфигурации
- [ ] Тест `pushToJobs()` с mock RPC

### 5.2 Integration тесты
- [ ] Тест отправки email через SMTP
- [ ] Тест появления задачи в Jobs
- [ ] Тест обработки ошибок

### 5.3 Документация
- [ ] Обновить README.md
- [ ] Создать migration-guide.md
- [ ] Добавить примеры конфигурации
- [ ] Обновить PHP consumer пример

---

## Критерии завершения проекта

- [ ] Все тесты проходят
- [ ] Нет worker pool кода
- [ ] SMTP плагин отправляет email в Jobs
- [ ] Документация обновлена
- [ ] Backward compatibility guide готов
