# RoadRunner SMTP Plugin Configuration Example
# Place this in your .rr.yaml file

version: "3"

# RPC configuration (optional - for management commands)
rpc:
  listen: tcp://127.0.0.1:6001

# Server configuration - defines PHP worker command
server:
  command: "php worker.php"
  relay: pipes
  relay_timeout: 20s

# SMTP Plugin Configuration
smtp:
  # Server configurations - can have multiple servers on different ports
  servers:
    # Server name: "buggregator" (used in events sent to PHP)
    buggregator:
      # Listen address and port
      addr: "127.0.0.1:1025"
      
      # Server hostname (returned in EHLO response)
      hostname: "buggregator.local"
      
      # Connection timeouts
      read_timeout: "60s"    # Max time waiting for client command
      write_timeout: "10s"   # Max time writing response to client
      
      # Email size limits
      max_message_size: 10485760  # 10MB in bytes (0 = unlimited)
      max_recipients: 100          # Max RCPT TO commands per transaction
    
    # Example: Additional SMTP server on different port
    # secondary:
    #   addr: "127.0.0.1:2525"
    #   hostname: "smtp2.local"
    #   read_timeout: "30s"
    #   write_timeout: "5s"
    #   max_message_size: 5242880  # 5MB
    #   max_recipients: 50
  
  # Attachment storage configuration
  attachment_storage:
    # Mode: "memory" or "tempfile"
    # - memory: Attachments encoded as base64 in JSON (simpler, works for small files)
    # - tempfile: Attachments saved to disk, path provided in JSON (better for large files)
    mode: "memory"
    
    # Temp directory for attachments (used only when mode=tempfile)
    temp_dir: "/tmp/smtp-attachments"
    
    # Auto-cleanup old temp files after this duration (only for tempfile mode)
    cleanup_after: "1h"
  
  # Include full raw RFC822 message in JSON payload (default: false)
  # Useful for debugging parsing issues, but increases payload size
  include_raw: false
  
  # PHP worker pool configuration
  pool:
    # Number of PHP worker processes
    num_workers: 4
    
    # Maximum jobs in queue (0 = unlimited)
    max_jobs: 0
    
    # Timeouts
    allocate_timeout: 60s   # Max time to allocate a worker
    destroy_timeout: 60s    # Max time to destroy a worker
    
    # Supervisor configuration
    supervisor:
      # Restart worker after N executions (0 = never, prevents memory leaks)
      max_worker_memory: 128
      
      # Time-to-live for worker processes
      ttl: 0s  # 0 = no TTL
      
      # Idle timeout (kill worker if idle for this duration)
      idle_ttl: 60s
      
      # Maximum number of jobs per worker before restart
      exec_ttl: 0  # 0 = unlimited

# Logs configuration
logs:
  level: debug
  encoding: console
  mode: development

# Metrics configuration (optional)
metrics:
  address: "127.0.0.1:2112"

# Health check endpoint (optional)
status:
  address: "127.0.0.1:2114"
